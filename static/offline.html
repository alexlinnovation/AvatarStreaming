<!DOCTYPE html>
<html>
<head>
    <title>Avatar WebRTC</title>
    <style>
        #videoContainer {
            width: 640px;
            height: 480px;
            border: 1px solid #ccc;
            margin: 20px auto;
        }
        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #controls {
            text-align: center;
            margin: 20px;
        }
        textarea {
            width: 80%;
            height: 100px;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="videoContainer">
        <img id="videoElement" />
    </div>
    
    <div id="controls">
        <textarea id="text" placeholder="Enter text to speak..."></textarea><br>
        <button onclick="sendSpeak()">Speak</button>
    </div>

    <script>
        const sessionId = "{{ sessionid }}";
        const videoElement = document.getElementById('videoElement');
        let socket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function connectWebSocket() {
            // Use the websocket_url provided by the server
            const wsUrl = "{{ websocket_url }}";
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
            };
            
            socket.onmessage = function(event) {
                if (event.data instanceof Blob) {
                    const url = URL.createObjectURL(event.data);
                    videoElement.onload = () => {
                        // Release previous blob URL to prevent memory leaks
                        if (videoElement.src.startsWith('blob:')) {
                            URL.revokeObjectURL(videoElement.src);
                        }
                    };
                    videoElement.src = url;
                }
            };
            
            socket.onclose = function() {
                console.log('WebSocket disconnected');
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * reconnectAttempts, 5000);
                    console.log(`Reconnecting in ${delay}ms...`);
                    setTimeout(connectWebSocket, delay);
                }
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                socket.close();
            };
        }
        
        async function sendSpeak() {
            const text = document.getElementById("text").value;
            if (!text) return;
            
            try {
                const response = await fetch("/speak", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ 
                        sessionid: sessionId, 
                        text, 
                        voice_style: "af_heart", 
                        speed: "1.1" 
                    })
                });
                
                const result = await response.json();
                if (result.status !== "ok") {
                    console.error("Error:", result.message || "Unknown error");
                }
            } catch (e) { 
                console.error("Error sending text:", e); 
            }
        }
        
        // Initialize WebSocket connection when page loads
        window.addEventListener('load', connectWebSocket);
    </script>
</body>
</html>