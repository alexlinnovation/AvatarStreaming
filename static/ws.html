<!DOCTYPE html>
<html>
<head>
    <title>Avatar Streamer</title>
    <style>
        #video-container {
            position: relative;
            width: 640px;
            height: 360px;
            border: 1px solid #ccc;
        }
        #avatar-video {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <img id="avatar-video" alt="Avatar Stream">
    </div>
    <div>
        <input type="text" id="text-input" placeholder="Enter text to speak">
        <button id="speak-btn">Speak</button>
    </div>
    
    <script>
        let websocket = null;
        let audioContext = null;
        let audioBufferSource = null;
        let connectionId = null;
        
        // Initialize WebSocket connection
        async function initConnection() {
            try {
                // Create new connection ID
                const response = await fetch('/create_connection');
                const data = await response.json();
                connectionId = data.connection_id;
                
                // Connect to WebSocket
                websocket = new WebSocket(`ws://${window.location.host}/ws/${connectionId}`);
                
                websocket.onopen = () => {
                    console.log('WebSocket connected');
                };
                
                websocket.onmessage = async (event) => {
                    const message = JSON.parse(event.data);
                    
                    if (message.type === 'video') {
                        // Update video frame
                        document.getElementById('avatar-video').src = 
                            `data:image/jpeg;base64,${message.data}`;
                    }
                    else if (message.type === 'audio') {
                        // Play received audio
                        await playAudio(message.data, message.sample_rate);
                    }
                };
                
                websocket.onclose = () => {
                    console.log('WebSocket disconnected');
                };
                
            } catch (error) {
                console.error('Connection failed:', error);
            }
        }
        
        // Play audio from base64 data
        async function playAudio(base64Data, sampleRate) {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Stop any currently playing audio
                if (audioBufferSource) {
                    audioBufferSource.stop();
                }
                
                // Decode base64 audio
                const binaryData = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
                const audioBuffer = await audioContext.decodeAudioData(
                    binaryData.buffer
                );
                
                // Create and play audio source
                audioBufferSource = audioContext.createBufferSource();
                audioBufferSource.buffer = audioBuffer;
                audioBufferSource.connect(audioContext.destination);
                audioBufferSource.start();
                
            } catch (error) {
                console.error('Audio playback error:', error);
            }
        }
        
        // Send text to speak
        async function speakText() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                console.error('WebSocket not connected');
                return;
            }
            
            const text = document.getElementById('text-input').value;
            if (!text.trim()) return;
            
            // Send speak command to server
            websocket.send(JSON.stringify({
                type: "speak",
                text: text,
                voice_style: "af_heart",
                speed: 1.1
            }));
            
            // Clear input
            document.getElementById('text-input').value = '';
        }
        
        // Initialize when page loads
        window.onload = () => {
            initConnection();
            document.getElementById('speak-btn').addEventListener('click', speakText);
        };
    </script>
</body>
</html>