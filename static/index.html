<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Digital Avatar</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; font-family: system-ui, sans-serif; }

    .app-header { background: #f4f6f8; padding: .8rem 1rem; border-bottom: 1px solid #e2e5e9; }

    .btn-grad {
      background: linear-gradient(135deg, #4d69ff, #7f3dff);
      color: #fff; border: none;
    }
    .btn-grad:hover { opacity: .9; }

    #video { width: 1000px; height: 700px; background: #000; border-radius: .5rem; }

    #self-wrap {
      position: absolute; right: 1rem; top: 1rem; width: 160px;
      border-radius: .5rem; overflow: hidden;
      box-shadow: 0 0 6px rgba(0, 0, 0, .6);
    }
    #self { width: 160px; height: 120px; background: #222; }

    #clock {
      position: absolute; left: 1rem; top: 1rem;
      font-size: 3rem; font-weight: 700; color: #fff;
      text-shadow: 0 0 6px #000; font-family: monospace;
    }

    #text { width: 100%; max-width: 500px; }

    .avatar-option {
      border: 2px solid transparent;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: 0.2s;
    }
    .avatar-option:hover {
      background-color: #f1f0ff;
    }
    .avatar-option.selected {
      border-color: #7f3dff;
      background-color: #eae6ff;
    }
    .avatar-img {
      width: 100px;
      height: auto;
      border-radius: 6px;
    }

  </style>
</head>
<body>

  <!-- ======== TOP HEADER ======== -->
  <header class="app-header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-start gap-3">
      <button class="btn btn-light border" style="width:40px;height:40px;">
        <i class="bi bi-arrow-left"></i>
      </button>
      <div>
        <h5 class="mb-0">Chat with Alice, Elenora and James - Assistants</h5>
        <small class="text-muted">Get 24 hours assistant for your questions!</small>
      </div>
    </div>
    <button class="btn btn-grad d-flex align-items-center gap-1 px-3">
      <i class="bi bi-box-arrow-up-right"></i>
      Share
    </button>
  </header>

  <!-- ======== MAIN CONTENT ======== -->
  <div class="container text-center py-4">
    <!-- AVATAR + SELECTOR ROW -->
    <div class="d-flex justify-content-center gap-4 mb-3">
      <!-- video + overlays -->
      <div class="position-relative">
        <video id="video" autoplay playsinline class="img-fluid" style="width:1000px;height:700px;background:#000;border-radius:.5rem;"></video>
        <div id="clock" hidden>00:00.000</div>
        <div id="self-wrap">
          <video id="self" autoplay muted playsinline></video>
        </div>
      </div>

      <!-- avatar selector RIGHT -->
      <div class="d-flex flex-column justify-content-start gap-3 pt-3" style="width:150px;">
        <div class="avatar-option selected" onclick="selectAvatar('static/avatar.png', this)">
          <img src="alice.png" class="avatar-img"><br>
          <strong>Alice</strong><br><small>Interview Assistant</small>
        </div>
        <div class="avatar-option" onclick="selectAvatar('static/idle.mp4', this)">
          <img src="elenora.png" class="avatar-img"><br>
          <strong>Elenora</strong><br><small>Customer Service</small>
        </div>
        <div class="avatar-option" onclick="selectAvatar('static/james.mp4', this)">
          <img src="james.png" class="avatar-img"><br>
          <strong>James</strong><br><small>Coding Assistant</small>
        </div>
      </div>
    </div>

    <!-- controls -->
    <div class="d-flex flex-column flex-sm-row justify-content-center gap-2 mt-3">
      <input type="text" id="text" class="form-control" placeholder="Enter textâ€¦">
      <button class="btn btn-grad px-4" onclick="connect()">Connect</button>
      <button class="btn btn-grad px-4" onclick="sendSpeak()">Speak</button>
    </div>
  </div>


<script>
  let pc = null, sessionId = null;
  let selectedAvatar = 'static/avatar.png';  // default
  let voiceStyle = 'af_heart';               // default voice

  function selectAvatar(path, el) {
    selectedAvatar = path;
    if (path.includes('avatar')) voiceStyle = 'af_heart';
    else if (path.includes('elenora')) voiceStyle = 'af_sky';
    else if (path.includes('james')) voiceStyle = 'am_adam';

    document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
    el.classList.add('selected');
  }


  let clockTimer = null, startTs = 0;
  function startClock() {
    clearInterval(clockTimer);
    startTs = performance.now();
    updateClock();
    clockTimer = setInterval(updateClock, 31);
  }
  function updateClock() {
    const now = performance.now() - startTs;
    const ms = Math.floor(now % 1000).toString().padStart(3, '0');
    const s = Math.floor(now / 1000) % 60;
    const m = Math.floor(now / 60000) % 60;
    document.getElementById('clock').textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${ms}`;
  }
  async function fetchIceServers() {
    const response = await fetch('/api/iceservers', { method: 'POST' });
    if (!response.ok) throw new Error('Failed to fetch ICE servers');
    const data = await response.json();
    return data.iceServers;
  }


  async function connect() {
    try {
      const iceServers = await fetchIceServers();

            pc = new RTCPeerConnection({
        iceServers,
        iceTransportPolicy: 'relay', // Optional: force TURN-only if needed
        bundlePolicy: 'balanced'
      });

      pc.addTransceiver('video', {direction: 'recvonly'});
      pc.addTransceiver('audio', {direction: 'recvonly'});

      pc.ontrack = e => {
        const v = document.getElementById('video');
        if (v && e.streams[0] && !v.srcObject) {
          v.srcObject = e.streams[0];
          v.play().catch(err => console.log('play err', err));
        }
      };

      await pc.setLocalDescription(await pc.createOffer());
      await new Promise(r => {
        const t = setTimeout(r, 8000);
        pc.onicecandidate = ev => { if (!ev.candidate) { clearTimeout(t); r(); } };
      });

      const reply = await fetch('/offer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sdp: pc.localDescription.sdp, type: pc.localDescription.type, src_img: selectedAvatar})
      });
      const ans = await reply.json();
      await pc.setRemoteDescription(new RTCSessionDescription(ans));
      sessionId = ans.sessionid;
    } catch (err) {
      console.error('Connection error:', err);
      alert('Failed to connect: ' + err.message);
    }
  }


  async function sendSpeak() {
    const text = document.getElementById('text').value.trim();
    if (!sessionId) { alert('Connect first'); return; }

    startClock();

    try {
      await fetch('/speak', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({
          sessionid: sessionId,
          text,
          voice_style: voiceStyle,
          speed: '1.1'
        })
      });
    } catch (e) { console.error('sendSpeak error:', e); }
  }
</script>

</body>
</html>
